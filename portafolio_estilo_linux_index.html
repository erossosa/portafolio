<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portafolio Docente — Estilo Linux</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f141a; --ink:#e6edf3; --muted:#9fb0c0; --accent:#3ddc84; --accent2:#61dafb; --danger:#ff6b6b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px var(--mono)}
    a{color:var(--accent2)} a:hover{opacity:.9}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #1b2430;background:linear-gradient(180deg,#0f141a,#0b0f14)}
    .title{font-weight:700;letter-spacing:.3px}
    .pill{background:#111922;border:1px solid #1f2a36;padding:6px 10px;border-radius:10px}
    .wrap{display:grid;grid-template-columns: 360px 1fr; gap:12px; padding:12px; height:calc(100% - 48px)}
    .panel{background:var(--panel);border:1px solid #1c2430;border-radius:12px;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #1b2430;color:#b7c5d3;letter-spacing:.3px}
    .panel .content{padding:10px;overflow:auto;}

    /* Terminal */
    .terminal{font:13px var(--mono);}
    .term-out{white-space:pre-wrap;min-height:240px; overflow:auto; padding:10px; background:#0a0f14; border-top:1px solid #1b2430}
    .prompt{display:flex; gap:8px; align-items:center; padding:8px; border-top:1px solid #1b2430}
    .badge{color:#111;background:var(--accent);padding:2px 6px;border-radius:6px;font-weight:700}
    .input{flex:1;background:#0b1118;color:var(--ink);border:1px solid #1c2430;border-radius:8px;padding:8px}

    /* Explorer */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .card{background:#0b1118;border:1px solid #1c2430;border-radius:10px;padding:10px;display:flex;gap:10px;align-items:center;cursor:pointer}
    .card:hover{border-color:#29445f}
    .icon{width:28px;height:28px;border-radius:6px;background:#12202e;display:grid;place-items:center;color:#8cc5ff}
    .sub{color:var(--muted);font-size:12px}

    /* Timeline */
    .tl{display:flex;flex-direction:column;gap:14px}
    .tl-item{border-left:3px solid var(--accent);padding:8px 12px;margin-left:6px;background:#0b1118;border-radius:10px;border:1px solid #1c2430}
    .tag{display:inline-block;margin-right:6px;margin-top:6px;padding:2px 6px;border-radius:6px;border:1px solid #203041;color:#b7d2ff;font-size:11px}

    /* Admin */
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .row label{width:140px;color:#b7c5d3}
    .row input,.row select,.row textarea{flex:1;background:#0b1118;color:var(--ink);border:1px solid #1c2430;border-radius:8px;padding:8px}
    .btn{border:1px solid #29445f;background:#112233;color:#d7ecff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:#133a2b;border-color:#1e624a;color:#c7ffe4}
    .btn-danger{background:#3a1a1a;border-color:#6b2a2a;color:#ffd7d7}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}

    .footer{padding:8px 12px;border-top:1px solid #1b2430;color:#7f93a8}
    .muted{color:#7f93a8}

    @media (max-width: 980px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="bar">
    <div class="title">eros@utu:~/portafolio — <span class="muted">Portafolio Docente • Estilo Linux (Híbrido)</span></div>
    <div class="toolbar">
      <button class="btn" id="btnImportLinks">Importar links.json</button>
      <button class="btn" id="btnImportTimeline">Importar timeline.csv</button>
      <button class="btn" id="btnExportLinks">Exportar links.json</button>
      <button class="btn" id="btnAdmin">Nuevo ítem</button>
      <button class="btn" id="btnPrivacy">Modo privacidad: <span id="privacyState">público</span></button>
      <button class="btn" id="btnHelp">Ayuda</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Columna izquierda: Terminal + Filtros / Búsqueda -->
    <section class="panel terminal">
      <h3>Terminal</h3>
      <div class="content">
        <div class="muted">Comandos: <code>help</code>, <code>ls</code>, <code>cd &lt;sección&gt;</code>, <code>open &lt;id&gt;</code>, <code>search &lt;texto&gt;</code>, <code>add</code>.</div>
      </div>
      <div id="termOut" class="term-out"></div>
      <div class="prompt">
        <span class="badge" id="cwd">~/</span>
        <input id="termIn" class="input" placeholder="escribí un comando y Enter…" autocomplete="off" />
      </div>
    </section>

    <!-- Columna derecha: Explorer + Timeline -->
    <section class="panel" style="min-height:0">
      <h3>Explorador</h3>
      <div class="content">
        <div class="row">
          <label for="q">Buscar</label>
          <input id="q" placeholder="filtrar por nombre, tipo o tag…" />
          <select id="sectionFilter"></select>
        </div>
        <div id="grid" class="grid"></div>
      </div>
      <div class="footer">Tip: clic en un ítem abre el enlace; clic con ALT copia el ID.</div>
    </section>

    <section class="panel" style="grid-column: 1 / -1; min-height:280px">
      <h3>Línea de tiempo (clase a clase)</h3>
      <div class="content">
        <div id="tl" class="tl"></div>
      </div>
    </section>

    <!-- NUEVO: Panel Grupo 2°MM -->
    <section class="panel" style="grid-column: 1 / -1; min-height:220px">
      <h3>Grupo 2°MM</h3>
      <div class="content">
        <div class="row">
          <label>Cargar people.json</label>
          <button class="btn" id="btnImportPeople">Importar people.json</button>
        </div>
        <div id="groupList" class="tl"></div>
      </div>
    </section>
  </div>

  <!-- Admin modal (inline, simple) -->
  <dialog id="adminDlg" style="max-width:820px;width:90%;background:#0b0f14;border:1px solid #203040;border-radius:12px;color:var(--ink)"> (inline, simple) -->
  <dialog id="adminDlg" style="max-width:820px;width:90%;background:#0b0f14;border:1px solid #203040;border-radius:12px;color:var(--ink)">
    <form method="dialog">
      <h3 style="margin:0 0 10px 0">Nuevo / Editar ítem</h3>
      <div class="row"><label>Sección</label>
        <select id="admSection"></select>
      </div>
      <div class="row"><label>Nombre visible</label><input id="admName" /></div>
      <div class="row"><label>Tipo</label>
        <select id="admType">
          <option value="gdoc">GDoc</option>
          <option value="pdf">PDF</option>
          <option value="html">HTML</option>
          <option value="reveal">Reveal.js</option>
          <option value="video">Video</option>
          <option value="link">Link</option>
        </select>
      </div>
      <div class="row"><label>URL (Drive u otra)</label><input id="admUrl" placeholder="https://…" /></div>
      <div class="row"><label>Descripción</label><textarea id="admDesc" rows="3"></textarea></div>
      <div class="row"><label>Borrador</label><select id="admDraft"><option value="false">No</option><option value="true">Sí</option></select></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn btn-primary" id="admSave" value="default">Guardar</button>
      </div>
    </form>
  </dialog>

  <input type="file" id="fileLinks" accept="application/json" hidden />
  <input type="file" id="fileTimeline" accept="text/csv" hidden />
  <input type="file" id="filePeople" accept="application/json" hidden />

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const byId = id => document.getElementById(id);
    const slug = s => (s||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,80);
    const fmtDate = s => new Date(s).toLocaleDateString('es-UY',{year:'numeric',month:'short',day:'2-digit'});
    const copy = async t => { try{ await navigator.clipboard.writeText(t);}catch(e){} }

    // ---------- State ----------
    let DB = { sections: [], timeline: [] };
    let PEOPLE = { group: "2°MM – ISBO – 2025", students: [] };
    let CWD = '~';
    let PRIV = (localStorage.getItem('privacy')||'public');

    // ---------- Load defaults (optional fetch) ----------
    async function tryFetchDefaults(){
      try{
        const [lj, tl, pj] = await Promise.all([
          fetch('links.json').then(r=>r.ok?r.json():null).catch(()=>null),
          fetch('timeline.csv').then(r=>r.ok?r.text():null).catch(()=>null),
          fetch('people.json').then(r=>r.ok?r.json():null).catch(()=>null)
        ]);
        if(lj){ DB.sections = lj.sections||[]; }
        if(tl){ DB.timeline = parseCSV(tl); }
        if(pj){ PEOPLE = pj; }
      }catch(e){ console.warn(e); }
      hydrateUI();
    }

    // ---------- CSV parser minimal ----------
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const head = lines.shift().split(',');
      return lines.map(line=>{
        // naive CSV (no quoted commas in our data)
        const cols = line.split(',');
        const o = {}; head.forEach((h,i)=>o[h.trim()] = (cols[i]||'').trim());
        o.tags = (o.tags||'').split('|').filter(Boolean);
        return o;
      });
    }

    // ---------- UI Rendering ----------
    function hydrateUI(){
      // Section filter
      const sel = byId('sectionFilter'); sel.innerHTML = '';
      const optAll = document.createElement('option'); optAll.value=''; optAll.textContent='Todas las secciones'; sel.appendChild(optAll);
      DB.sections.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.title||s.id; sel.appendChild(o); });
      renderExplorer();
      renderTimeline();
      renderGroup();
      renderPrompt();
    }

    function renderExplorer(){
      const q = byId('q').value.toLowerCase();
      const sec = byId('sectionFilter').value;
      const grid = byId('grid'); grid.innerHTML = '';
      const secs = sec? DB.sections.filter(s=>s.id===sec): DB.sections;
      const items = secs.flatMap(s=> (s.items||[]).map(it=> ({...it, _section:s}))); 
      const filtered = items.filter(it=>{
        const blob = [it.name,it.type,(it.tags||[]).join(' '),it._section.title].join(' ').toLowerCase();
        return !q || blob.includes(q);
      });
      if(!filtered.length){ grid.innerHTML = '<div class="muted">No hay resultados. Probá limpiar filtros.</div>'; return; }
      for(const it of filtered){
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="icon">📄</div>
          <div style="flex:1">
            <div><strong>${it.name||'(sin nombre)'} </strong> ${it.draft?'<span class="tag">borrador</span>':''}</div>
            <div class="sub">${it._section.title} • <em>${it.type||'link'}</em></div>
            <div class="sub">id: <code>${it.id}</code></div>
          </div>`;
        el.addEventListener('click', (ev)=>{
          if(ev.altKey){ copy(it.id); toast(`copiado id: ${it.id}`); return; }
          if(it.url){ window.open(it.url, '_blank'); }
          else { toast('Este ítem está en borrador (sin URL). Abrí el panel "Nuevo ítem" para completarlo.'); }
        });
        grid.appendChild(el);
      }
    }

    function renderTimeline(){
      const tl = byId('tl'); tl.innerHTML = '';
      (DB.timeline||[]).forEach(ev=>{
        const div = document.createElement('div'); div.className='tl-item';
        div.innerHTML = `<div><strong>${fmtDate(ev.date)}</strong> — ${ev.title} <span class="sub">(${ev.unit})</span></div>
                         <div class="sub">${ev.summary||''}</div>
                         <div>${(ev.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>`;
        tl.appendChild(div);
      })
    }

    function renderPrompt(){ byId('cwd').textContent = `eros@utu:${CWD}$`; }

    function print(s){ const out = byId('termOut'); out.textContent += s + "\n"; out.scrollTop = out.scrollHeight; }
    function clearOut(){ byId('termOut').textContent=''; }

    // ---------- Terminal commands ----------
    const CMDS = {
      help(){
        print("Comandos disponibles:\n - help\n - ls [sección]\n - cd <sección>\n - open <id>\n - search <texto>\n - add (abre panel para crear ítem)\n - clear");
      },
      ls(arg){
        const secs = arg? DB.sections.filter(s=> slug(s.id)===slug(arg)||slug(s.title)===slug(arg)) : DB.sections;
        secs.forEach(s=>{
          print(`\n${s.title||s.id}/`);
          (s.items||[]).forEach(it=>{
            print(`  ${it.id}  (${it.type||'link'})  ${it.name}${it.draft?' [borrador]':''}`);
          })
        })
      },
      cd(arg){
        if(!arg){ CWD='~/'; renderPrompt(); return; }
        const s = DB.sections.find(x=> slug(x.id)===slug(arg)||slug(x.title)===slug(arg));
        if(!s) return print('Sección no encontrada');
        CWD = `~/${s.id}`; renderPrompt();
        this.ls(s.id);
      },
      open(id){
        const it = DB.sections.flatMap(s=> (s.items||[])).find(x=>x.id===id);
        if(!it) return print('ID no encontrado');
        if(!it.url) return print('Ítem sin URL (borrador). Completalo desde el panel.');
        window.open(it.url, '_blank');
      },
      search(q){
        q = (q||'').toLowerCase();
        const hits = [];
        DB.sections.forEach(s=> (s.items||[]).forEach(it=>{
          const blob = [s.title,it.name,it.type,(it.tags||[]).join(' ')].join(' ').toLowerCase();
          if(blob.includes(q)) hits.push({s,it});
        }))
        if(!hits.length) return print('Sin resultados');
        hits.forEach(h=> print(`${h.s.title}/${h.it.id}  -> ${h.it.name}`));
      },
      add(){ openAdmin(); },
      clear(){ clearOut(); }
    }

    byId('termIn').addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const raw = e.target.value.trim(); e.target.value='';
        if(!raw) return;
        print(`$ ${raw}`);
        const [cmd, ...rest] = raw.split(/\s+/);
        const arg = rest.join(' ');
        (CMDS[cmd]||(()=>print('Comando no reconocido. Escribí "help".'))).call(CMDS, arg);
      }
    })

    // ---------- Admin (mini backend local) ----------
    function openAdmin(){
      const dlg = byId('adminDlg');
      // secciones
      const sel = byId('admSection'); sel.innerHTML='';
      DB.sections.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.title||s.id; sel.appendChild(o); });
      byId('admName').value=''; byId('admType').value='gdoc'; byId('admUrl').value=''; byId('admDesc').value=''; byId('admDraft').value='true';
      dlg.showModal();
      byId('admSave').onclick = (ev)=>{
        ev.preventDefault();
        const sid = byId('admSection').value;
        const sec = DB.sections.find(s=>s.id===sid);
        if(!sec){ dlg.close(); return; }
        const name = byId('admName').value.trim();
        const type = byId('admType').value;
        const url = byId('admUrl').value.trim();
        const desc = byId('admDesc').value.trim();
        const draft = byId('admDraft').value==='true';
        const id = slug(name)||('item-'+Date.now());
        sec.items = sec.items||[];
        sec.items.push({id,name,type,url,desc,draft});
        persistLocal(); hydrateUI(); dlg.close(); toast('Ítem creado. Recordá exportar links.json para actualizar el repo.');
      }
    }

    function persistLocal(){ localStorage.setItem('PORT_LINKS', JSON.stringify(DB.sections)); }
    function loadLocal(){
      const x = localStorage.getItem('PORT_LINKS');
      if(x){ try{ DB.sections = JSON.parse(x);}catch(e){} }
    }

    // ---------- File import/export ----------
    byId('btnImportLinks').onclick = ()=> byId('fileLinks').click();
    byId('fileLinks').onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const json = JSON.parse(text);
        DB.sections = json.sections||json; // acepta esquema plano
        persistLocal(); hydrateUI(); toast('links.json importado');
      }catch(err){ alert('Archivo inválido'); }
      e.target.value='';
    }

    byId('btnImportTimeline').onclick = ()=> byId('fileTimeline').click();
    byId('fileTimeline').onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      DB.timeline = parseCSV(text);
      localStorage.setItem('PORT_TL', JSON.stringify(DB.timeline));
      renderTimeline(); toast('timeline.csv importado');
      e.target.value='';
    }

    byId('btnExportLinks').onclick = ()=>{
      const payload = { sections: DB.sections, timeline: DB.timeline };
      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'links.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Privacy toggle ----------
    function setPrivacy(mode){ PRIV = mode; localStorage.setItem('privacy', mode); byId('privacyState').textContent = mode; }
    byId('btnPrivacy').onclick = ()=> setPrivacy(PRIV==='public'?'cátedra':'public');

    // ---------- Search & filter ----------
    byId('q').addEventListener('input', renderExplorer);
    byId('sectionFilter').addEventListener('change', renderExplorer);

    // ---------- Help ----------
    byId('btnHelp').onclick = ()=>{
      alert('» Importá tus archivos links.json y timeline.csv (botones arriba)\n» Usá la Terminal para navegar (help, ls, cd, open, search)\n» Con “Nuevo ítem” creás materiales sin link (borrador) y luego Exportás links.json para subir al repo.');
    }

    // ---------- Toast ----------
    let TO=null; function toast(msg){
      clearTimeout(TO);
      const n = document.createElement('div'); n.textContent = msg; n.style.cssText = 'position:fixed;bottom:16px;right:16px;background:#12202e;border:1px solid #25465f;padding:10px 12px;border-radius:10px;color:#d7ecff;z-index:99';
      document.body.appendChild(n); TO=setTimeout(()=>n.remove(), 2400);
    }

    // ---------- Boot ----------
    loadLocal();
    tryFetchDefaults();
    setPrivacy(PRIV);
    print('Bienvenido. Cargá tus archivos links.json / timeline.csv o empezá a crear ítems con "Nuevo ítem".\nEscribí "help" para ver comandos.');
      // ---------- Grupo 2°MM ----------
    function anonName(full){
      if(PRIV==='public'){
        const parts = (full||'').split(' ');
        if(parts.length===1) return (full||'').slice(0,1)+'.';
        return `${parts[0]} ${parts[1]?.slice(0,1)||''}.`;
      }
      return full;
    }
    function renderGroup(){
      const box = byId('groupList'); box.innerHTML='';
      const title = document.createElement('div'); title.className='sub'; title.textContent = PEOPLE.group||'Grupo 2°MM'; box.appendChild(title);
      (PEOPLE.students||[]).forEach(st=>{
        const el = document.createElement('div'); el.className='tl-item';
        const tags = (st.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('');
        const notes = st.notes? `<div class='sub'>${st.notes}</div>`:'';
        const ad = (st.adaptations||[]).length? `<div class='sub'>Adaptaciones: ${(st.adaptations||[]).join(', ')}</div>`:'';
        const ev = (st.evidenceLinks||[]).map(u=>`<a href='${u}' target='_blank'>evidencia</a>`).join(' · ');
        el.innerHTML = `<div><strong>${anonName(st.name||'(sin nombre)')}</strong> ${tags}</div>${notes}${ad}<div>${ev}</div>`;
        box.appendChild(el);
      });
      if(!(PEOPLE.students||[]).length){
        const tip = document.createElement('div'); tip.className='sub';
        tip.textContent = 'Importá un people.json o añadí estudiantes editando el archivo.';
        box.appendChild(tip);
      }
    }

    // Import people.json
    byId('btnImportPeople').onclick = ()=> byId('filePeople').click();
    byId('filePeople').onchange = async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try{ PEOPLE = JSON.parse(await f.text()); }catch(err){ alert('people.json inválido'); return; }
      localStorage.setItem('PORT_PEOPLE', JSON.stringify(PEOPLE));
      renderGroup(); toast('people.json importado');
      e.target.value='';
    }

    // Persist people locally as well
    (function(){
      const p = localStorage.getItem('PORT_PEOPLE'); if(p){ try{ PEOPLE = JSON.parse(p);}catch(e){} }
    })();

    // Re-render on privacy toggle
    const oldSetPrivacy = setPrivacy;
    setPrivacy = function(mode){ oldSetPrivacy(mode); renderGroup(); };

  </script>
</body>
</html>
